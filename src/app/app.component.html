<div
  id="container"
  class="game"
  [class]="'game--' + gameItem.class"
  [class.playing]="playing"
  [style.--m]="game.width"
  [style.--n]="game.height"
>
  <aside id="left-side">
    <div #stats id="fpsStats"></div>
    <div class="controls">
      <mat-select
        (selectionChange)="onGameChange($event)"
        [(ngModel)]="gameItem"
      >
        <mat-option *ngFor="let game of Games" [value]="game">
          {{ game.title }}
        </mat-option>
      </mat-select>
      <mat-select
        (selectionChange)="onOptionsChange($event)"
        [(ngModel)]="gameOptions"
        *ngIf="gameItem.options?.length"
      >
        <mat-option *ngFor="let option of gameItem.options" [value]="option">
          {{ option.title }}
        </mat-option>
      </mat-select>
    </div>
    <div class="controls">
      <div class="control-group">
        <button mat-icon-button (click)="onReset()">
          <mat-icon>restart_alt</mat-icon>
        </button>
        <button
          mat-icon-button
          (click)="doStep()"
          [disabled]="playing || paused"
        >
          <mat-icon>skip_next</mat-icon>
        </button>
        <button mat-icon-button (click)="onTogglePlay()" [disabled]="paused">
          <mat-icon *ngIf="playing">pause</mat-icon>
          <mat-icon *ngIf="!playing">play_arrow</mat-icon>
        </button>
      </div>
      <mat-slider min="-5" max="5" step="1" value="1.5" discrete showTickMarks>
        <input matSliderThumb [(ngModel)]="speed" />
      </mat-slider>
    </div>
    <div id="pallet" class="controls">
      <div class="set" *ngFor="let set of game.pallet; trackBy: trackByMethod">
        <button
          mat-fab
          *ngFor="let type of set; trackBy: trackByMethod"
          [title]="type.state"
          class="cell"
          [class]="'cell--' + type.state"
          [class.active]="currentType.state === type.state"
          (click)="currentType = type"
        >
          <span>{{ type.display || type.token }}</span>
        </button>
      </div>
    </div>
  </aside>
  <div id="content">
    <div id="stats">
      <span *ngFor="let stat of game.stats | keyvalue">
        {{ stat.key }}: {{ stat.value }}
      </span>
    </div>
    <table
      #board
      id="board"
      oncontextmenu="return false;"
      (mouseleave)="onMouseLeave()"
      (touchstart)="onTouch($event)"
      (touchmove)="onTouch($event)"
      (touchend)="onMouseLeave()"
      (touchcancel)="onMouseLeave()"
    >
      <tr *ngFor="let row of game.grid; let y = index; trackBy: trackByMethod">
        <td
          *ngFor="
            let cell of game.grid[y];
            let x = index;
            trackBy: trackByMethod
          "
          (mousedown)="onMouseEnter($event, x, y)"
          (mouseenter)="onMouseEnter($event, x, y)"
          (click)="onClick($event, x, y)"
          (mouseup)="onMouseLeave()"
          class="cell"
          [class]="'cell--' + cell.state"
        >
          <span>{{ cell.display || cell.token }}</span>
        </td>
      </tr>
    </table>
  </div>
  <aside id="right-side">
    <div class="controls">
      <button mat-button (click)="onRandom()">Random</button>
      <button mat-button (click)="onClear()">Clear</button>
    </div>
    <div class="controls">
      <div
        class="pattern-container"
        *ngFor="
          let pattern of gameItem.savedPatterns;
          let i = index;
          trackBy: trackByMethod
        "
      >
        <button
          mat-mini-fab
          (click)="onRemovePattern(pattern)"
          *ngIf="i >= gameItem.patterns.length - 1"
        >
          <mat-icon>close</mat-icon>
        </button>
        <ng-container
          *ngTemplateOutlet="miniBoard; context: { pattern }"
        ></ng-container>
      </div>
      <button mat-button (click)="onAddPattern()">+ Save Pattern</button>
    </div>
  </aside>
</div>

<ng-template #miniBoard let-pattern="pattern">
  <table class="pattern-board" (click)="onUsePattern(pattern)">
    <tr *ngFor="let row of pattern; let y = index; trackBy: trackByMethod">
      <td
        *ngFor="let cell of pattern[y]; let x = index; trackBy: trackByMethod"
        class="cell"
        [class]="'cell--' + cell.state"
      >
        <span>{{ cell.display || cell.token }}</span>
      </td>
    </tr>
  </table>
</ng-template>
